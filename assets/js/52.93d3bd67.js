(window.webpackJsonp=window.webpackJsonp||[]).push([[52],{478:function(_,v,s){"use strict";s.r(v);var t=s(2),a=Object(t.a)({},(function(){var _=this,v=_._self._c;return v("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[v("p",[_._v("单节点Redis并发能力虽然不错")]),_._v(" "),v("p",[_._v("但数十万甚至百万的并发也无法满足")]),_._v(" "),v("p",[_._v("所以需要搭建Redis集群")]),_._v(" "),v("p",[_._v("一般来说是主从集群")]),_._v(" "),v("blockquote",[v("p",[_._v("为什么不做成传统的负载均衡呢?")])]),_._v(" "),v("p",[_._v("因为Redis应用中读多写少")]),_._v(" "),v("p",[_._v("为了应对"),v("strong",[_._v("读多")]),_._v("的压力")]),_._v(" "),v("p",[_._v("搭建主从集群有助于实现读写分离")]),_._v(" "),v("p",[v("img",{attrs:{src:"https://18334034784.oss-cn-chengdu.aliyuncs.com/lin-oss/Redis%E4%B8%BB%E4%BB%8E%E9%9B%86%E7%BE%A4.png",alt:"image-20231121210420750"}})]),_._v(" "),v("blockquote",[v("p",[_._v("如何使相同的操作访问同一个节点呢?")])]),_._v(" "),v("p",[_._v("我在master主节点上进行写操作")]),_._v(" "),v("p",[_._v("slave从节点操作是不可见的")]),_._v(" "),v("p",[_._v("为了使他可见")]),_._v(" "),v("p",[_._v("需要做一些数据同步")]),_._v(" "),v("p",[_._v("master <====> salve")]),_._v(" "),v("p",[_._v("下面聊聊数据同步的原理")]),_._v(" "),v("h2",{attrs:{id:"一-全量同步"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#一-全量同步"}},[_._v("#")]),_._v(" 一.全量同步")]),_._v(" "),v("p",[_._v("Redis主从的第一次同步是"),v("font",{attrs:{color:"red"}},[_._v("全量同步")])],1),_._v(" "),v("p",[_._v("一般来说全量同步分为三个阶段")]),_._v(" "),v("ol",[v("li",[_._v("主从节点建立连接")]),_._v(" "),v("li",[_._v("数据同步")]),_._v(" "),v("li",[_._v("同步新的数据")])]),_._v(" "),v("h3",{attrs:{id:"_1-第一阶段-主从节点建立连接"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-第一阶段-主从节点建立连接"}},[_._v("#")]),_._v(" 1.第一阶段 : 主从节点建立连接")]),_._v(" "),v("p",[v("img",{attrs:{src:"https://18334034784.oss-cn-chengdu.aliyuncs.com/lin-oss/%E5%85%A8%E9%87%8F%E5%90%8C%E6%AD%A5%E7%AC%AC%E4%B8%80%E9%98%B6%E6%AE%B5.png",alt:"image-20231121213841339"}})]),_._v(" "),v("ol",[v("li",[_._v("第一次建立连接时从节点请求数据同步")]),_._v(" "),v("li",[_._v("此时master判断是否是第一次同步")]),_._v(" "),v("li",[_._v("是第一次则返回mater的数据版本信息,方便日后做版本控制")]),_._v(" "),v("li",[_._v("从节点保存当前版本信息")])]),_._v(" "),v("p",[_._v("这里涉及到两个重要概念")]),_._v(" "),v("ul",[v("li",[_._v("Replication Id : 简称replid.是数据集的标记,id一致说明是一个数据集.每一个master都有唯一的id,slave则会继承master节点的replid")]),_._v(" "),v("li",[_._v("offect : 随着记录增多,slave完成同步时也会记录当前同步的offset,如果slave的offset小于master的offset,则说明数据落后,需要更新")])]),_._v(" "),v("h3",{attrs:{id:"_2-第二阶段-数据同步"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_2-第二阶段-数据同步"}},[_._v("#")]),_._v(" 2.第二阶段 : 数据同步")]),_._v(" "),v("p",[v("img",{attrs:{src:"https://18334034784.oss-cn-chengdu.aliyuncs.com/lin-oss/%E5%85%A8%E9%87%8F%E5%90%8C%E6%AD%A5%E7%AC%AC%E4%BA%8C%E9%98%B6%E6%AE%B5.png",alt:"image-20231121214909618"}})]),_._v(" "),v("ol",[v("li",[_._v("数据同步时,如何获取到master节点的所有数据?答案就是RDB")]),_._v(" "),v("li",[_._v("RDB比较耗时,在此期间所产生的新数据会被master节点记录在"),v("strong",[_._v("repl_backlog")]),_._v("缓冲区中")]),_._v(" "),v("li",[_._v("清空原来的数据,加载新的数据")])]),_._v(" "),v("h3",{attrs:{id:"_3-第三阶段-同步新的命令"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_3-第三阶段-同步新的命令"}},[_._v("#")]),_._v(" 3.第三阶段 : 同步新的命令")]),_._v(" "),v("p",[v("strong",[_._v("repl_backlog")]),_._v("缓冲区中的数据是RDB时产生的新数据")]),_._v(" "),v("p",[_._v("会在第三阶段一条一条同步给slave")]),_._v(" "),v("h2",{attrs:{id:"二-增量同步"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#二-增量同步"}},[_._v("#")]),_._v(" 二.增量同步")]),_._v(" "),v("p",[_._v("从上面我们可以知道")]),_._v(" "),v("p",[_._v("全量同步步骤繁琐,更新数据量较大")]),_._v(" "),v("p",[_._v("故而只在主从"),v("strong",[_._v("第一次同步")]),_._v("时使用")]),_._v(" "),v("p",[_._v("如果slave重启后同步,则会执行"),v("strong",[_._v("增量同步")])]),_._v(" "),v("p",[v("img",{attrs:{src:"https://18334034784.oss-cn-chengdu.aliyuncs.com/lin-oss/%E5%A2%9E%E9%87%8F%E5%90%8C%E6%AD%A5.png",alt:"image-20231121220337553"}})]),_._v(" "),v("p",[_._v("注意看2.1这一步")]),_._v(" "),v("p",[_._v("master和全量同步不同的是,不再一条一条信息同步到slave")]),_._v(" "),v("p",[_._v("而是获取"),v("strong",[_._v("offset")]),_._v("后的数据再发送给slave")]),_._v(" "),v("p",[v("big",[v("strong",[_._v("repl_backlog")])])],1),_._v(" "),v("p",[_._v("本质是一个环形数组")]),_._v(" "),v("div",{attrs:{align:"left"}},[v("img",{attrs:{src:"https://18334034784.oss-cn-chengdu.aliyuncs.com/lin-oss/repl_backlog.png",alt:"repl_cbacklog",width:"200",height:"200"}})]),_._v(" "),v("p",[_._v("获取到的master_offset和slave_offset不相同")]),_._v(" "),v("p",[_._v("slave做增量同步时")]),_._v(" "),v("p",[_._v("红色部分即为差异的数据")]),_._v(" "),v("p",[_._v("只要数据不超过repl_backlog,master更新则会覆盖之前的部分")]),_._v(" "),v("p",[_._v("slave_offset将会一直追赶master_offset")]),_._v(" "),v("p",[_._v("但是有一个问题")]),_._v(" "),v("blockquote",[v("p",[_._v("slave宕机太久,master新增的数据操作repl_backlog大小怎么办?")])]),_._v(" "),v("div",{attrs:{align:"left"}},[v("img",{attrs:{src:"https://18334034784.oss-cn-chengdu.aliyuncs.com/lin-oss/%E5%A2%9E%E9%87%8F%E5%90%8C%E6%AD%A5%E9%97%AE%E9%A2%98.png",alt:"repl_cbacklog",width:"200",height:"200"}})]),_._v(" "),v("p",[_._v("这样会导致尚未备份的数据被覆盖,则无法实现增量同步,只能再次全量同步")]),_._v(" "),v("h3",{attrs:{id:"数据同步注意事项"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#数据同步注意事项"}},[_._v("#")]),_._v(" 数据同步注意事项")]),_._v(" "),v("p",[_._v("我们可以从以下几个方面优化Redis主从集群")]),_._v(" "),v("ul",[v("li",[_._v("在master中配置"),v("code",[_._v("repl-diskless-sync yes")]),_._v("启用无磁盘复制，避免全量同步时的磁盘IO")]),_._v(" "),v("li",[_._v("Redis单节点上的内存占用不要太大，减少RDB导致的过多磁盘IO")]),_._v(" "),v("li",[_._v("适当提高repl_baklog的大小，发现slave宕机时尽快实现故障恢复，尽可能避免全量同步")]),_._v(" "),v("li",[_._v("限制一个master上的slave节点数量，如果实在是太多slave，则可以采用主-从-从链式结构，减少master压力")])])])}),[],!1,null,null,null);v.default=a.exports}}]);