(window.webpackJsonp=window.webpackJsonp||[]).push([[55],{480:function(t,s,e){"use strict";e.r(s);var a=e(2),v=Object(a.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("p",[t._v("Redis是内存存储,服务重启可能会丢失数据")]),t._v(" "),s("p",[t._v("所以我们想个办法将Redis的数据做持久化")]),t._v(" "),s("h2",{attrs:{id:"一-rdb"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一-rdb"}},[t._v("#")]),t._v(" 一.RDB")]),t._v(" "),s("p",[t._v("全称 "),s("strong",[t._v("Redis Database Backup file")]),t._v(", Redis数据备份文件,也被叫做"),s("strong",[t._v("Redis数据快照")])]),t._v(" "),s("p",[t._v("就是把内存中的所有记录都记录磁盘中")]),t._v(" "),s("p",[t._v("当Redis实例故障重启后,从磁盘读取快照文件,恢复数据")]),t._v(" "),s("p",[t._v("快照文件被称为RDB文件,默认是保存在当前运行目录")]),t._v(" "),s("h3",{attrs:{id:"_1-rdb使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-rdb使用"}},[t._v("#")]),t._v(" 1.RDB使用")]),t._v(" "),s("p",[t._v("下面是两种执行RDB的命令")]),t._v(" "),s("h4",{attrs:{id:"_1-save-命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-save-命令"}},[t._v("#")]),t._v(" 1).save 命令")]),t._v(" "),s("p",[t._v("由Redis主进程来执行RDB,会阻塞所有命令")]),t._v(" "),s("p",[t._v("如果数据量比较大的话")]),t._v(" "),s("p",[t._v("且磁盘IO较慢")]),t._v(" "),s("p",[t._v("会导致等待时间过长")]),t._v(" "),s("p",[t._v("一般用于快要停机时使用")]),t._v(" "),s("p",[t._v("故不建议使用")]),t._v(" "),s("h4",{attrs:{id:"_2-bgsave-命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-bgsave-命令"}},[t._v("#")]),t._v(" 2).bgsave 命令")]),t._v(" "),s("p",[t._v("开启子进程执行RDB,避免主进程受到影响")]),t._v(" "),s("p",[t._v("后台保存开始")]),t._v(" "),s("h4",{attrs:{id:"_3-内部触发rdb"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-内部触发rdb"}},[t._v("#")]),t._v(" 3).内部触发RDB")]),t._v(" "),s("p",[t._v("在redis.conf文件内")]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#900秒内,如果至少有一个key被修改了,则执行bgsave ")]),t._v("\nsave "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("900")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br")])]),s("h3",{attrs:{id:"_2-fork原理"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-fork原理"}},[t._v("#")]),t._v(" 2.fork原理")]),t._v(" "),s("blockquote",[s("p",[t._v("fork : 系统调用,从当前进程中切出去一个子进程")])]),t._v(" "),s("p",[t._v("bgsave开始时会fork主进程得到子进程,子进程共享主进程的内存数据")]),t._v(" "),s("p",[t._v("完成fork后读取内存数据并写入RDB文件")]),t._v(" "),s("blockquote",[s("p",[t._v("bgsave操作是几乎零阻塞的")])]),t._v(" "),s("p",[t._v("为什么是几乎?")]),t._v(" "),s("p",[t._v("因为读取内存数据并写入RDB文件这个操作是异步的")]),t._v(" "),s("p",[t._v("但是fork操作是阻塞的")]),t._v(" "),s("p",[t._v("所以我们需要减少fork所花费的时间")]),t._v(" "),s("p",[s("big",[s("strong",[t._v("fork原理")])])],1),t._v(" "),s("p",[t._v("我们知道")]),t._v(" "),s("p",[t._v("Redis是操作物理内存的")]),t._v(" "),s("p",[t._v("但是Linux的所有进程都无法直接操作物理内存")]),t._v(" "),s("p",[t._v("而是给每个进程都分配一个"),s("strong",[t._v("虚拟内存")])]),t._v(" "),s("p",[t._v("主进程只能操作虚拟内存")]),t._v(" "),s("p",[t._v("Linux会维护一个虚拟内存与物理内存的映射表")]),t._v(" "),s("p",[t._v("称为"),s("strong",[t._v("页表")])]),t._v(" "),s("p",[t._v("fork时,我们复制的是页表")]),t._v(" "),s("p",[t._v("有了相同的映射关系")]),t._v(" "),s("p",[t._v("实现了主进程和子进程的内存空间共享")]),t._v(" "),s("p",[t._v("再通过子进程写一个新的RDB文件替换旧RDB文件")]),t._v(" "),s("p",[t._v("但是有个问题")]),t._v(" "),s("p",[t._v("子进程在写数据时,主进程可以修改数据")]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"title"}),s("p",[t._v("如何保证主进程与子进程之间的数据一致性?")])]),s("p",[t._v("fork采用的是"),s("strong",[t._v("copy-on-write")]),t._v("技术 :")]),t._v(" "),s("p",[t._v("fork会把当前数据标为"),s("strong",[t._v("read-only")]),t._v("只读模式")]),t._v(" "),s("ul",[s("li",[t._v("当主进程执行读操作时,访问共享内存")]),t._v(" "),s("li",[t._v("当主进程执行写操作时,则会拷贝一份数据执行写操作(极端情况下内存翻倍,挤爆服务器)")])]),t._v(" "),s("p",[t._v("RDB的应用场景就是追求更高的启动速度,也就是性能")]),t._v(" "),s("h2",{attrs:{id:"二-aof"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二-aof"}},[t._v("#")]),t._v(" 二.AOF")]),t._v(" "),s("p",[t._v("AOF全称为Append Only File(追加文件)")]),t._v(" "),s("p",[t._v("Redis处理的"),s("font",{attrs:{color:"red"}},[t._v("每一个写命令")]),t._v("都会记录在AOF文件，可以看做是命令日志文件")],1),t._v(" "),s("p",[t._v("恢复数据时,执行AOF文件,执行文件中的命令")]),t._v(" "),s("p",[t._v("假设有一个命令")]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" num "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("123")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("那么AOF的文件形式就是")]),t._v(" "),s("div",{staticClass:"language-AOF line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("$3\nset\n$3\nnum\n$3\n123\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("p",[t._v("3表示长度")]),t._v(" "),s("p",[t._v("AOF默认是关闭的，需要修改redis.conf配置文件来开启AOF:")]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#是否开启AOF功能,默认是no")]),t._v("\nappendonly "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("yes")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#AOF文件的名称")]),t._v("\nappendfilename "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"appendonly.aof"')]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("p",[t._v("AOF的命令记录的频率也可以通过redis.conf文件来配:")]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#表示每执行一次写命令，立即记录到AOF文件")]),t._v("\nappendfsync always\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#写命令执行完先放入AOF缓冲区，然后表示每隔1秒将缓冲区数据写到AOF文件，是默认方案")]),t._v("\nappendfsync everysec\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#写命令执行完先放入AOF缓冲区，由操作系统决定何时将缓冲区内容写回磁盘")]),t._v("\nappendfsync no\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br")])]),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"center"}},[t._v("配置项")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("刷盘实际")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("优点")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("缺点")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("Always")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("同步刷盘")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("可靠性高")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("性能影响大")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("everysec")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("每秒刷盘")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("性能适中")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("最多丢失一秒数据")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("no")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("操作系统控制")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("性能最好")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("可靠性较差")])])])]),t._v(" "),s("p",[s("big",[s("strong",[t._v("AOF的问题")])])],1),t._v(" "),s("p",[t._v("因为是记录命令，AOF文件会比RDB文件大的多")]),t._v(" "),s("p",[t._v("而且AOF会记录对同一个key的多次写操作，但只有最后一次写操作才有意义")]),t._v(" "),s("p",[t._v("通过执行"),s("strong",[t._v("bgrewriteaof")]),t._v("命令，可以让AOF文件执行重写功能，用最少的命令达到相同效果")]),t._v(" "),s("p",[s("img",{attrs:{src:"https://18334034784.oss-cn-chengdu.aliyuncs.com/lin-oss/bgrewriteaof.png",alt:"image-20231120210641014"}})]),t._v(" "),s("p",[t._v("AOF的应用场景就是对数据安全性要求较高")])])}),[],!1,null,null,null);s.default=v.exports}}]);